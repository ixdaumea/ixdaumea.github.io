<html>
<head>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script src="local.js"></script>
<script src="api_key.js"></script>

<script id="config" type="text/javascript" charset="utf-8">
  var $parameters = {
    urlname: "UX-Umea-Meetup",
  };
  var $queries = {
    groups: function() {
      return mup_widget.api_call("/2/groups", {group_urlname: $parameters.urlname});
    },
    events: function() {
      return mup_widget.api_call("/2/events", {group_urlname: $parameters.urlname, page: '1'});
    }
  };

</script>
<script type="text/javascript" charset="utf-8">
	mup_widget.with_jquery(function($, ctx) {
		var	group = '',
				months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
				addLink = function(content, link) {
						return '<a target="_top" href="' + link + '">' + content + '</a>';
	      },
				addLeadingZero = function( num ) {
						return (num < 10) ? ('0' + num) : num;
					},
				getFormattedDate = function( millis ) {
						var date = new Date( millis );
						return  months[date.getMonth()] + ' ' + addLeadingZero( date.getDate() ) + ', ' + date.getFullYear().toString();
					},
				getFormattedTime = function( millis ) {
						var	time = new Date( millis ),
								hours = time.getHours(),
								min = time.getMinutes(),
								ampm = (hours > 11) ? 'PM' : 'AM';
						min = (min < 10) ? ('0' + min) : min;
						hours = (hours == 0) ? 1 : hours;
						hours = (hours > 12) ? hours-12 : hours;
						return hours + ':' + min + ' ' + ampm;
					},
				numberFormat = function(nStr){
					  nStr += '';
					  x = nStr.split('.');
					  x1 = x[0];
					  x2 = x.length > 1 ? '.' + x[1] : '';
					  var rgx = /(\d+)(\d{3})/;
					  while (rgx.test(x1))
					    x1 = x1.replace(rgx, '$1' + ',' + '$2');
					  return x1 + x2;
					};

		$.getJSON($queries.groups(), function(data) {
	    if (data.results.length == 0) {
				$('.mug-badge', ctx).append(
					'<div class="mup-widget error">\
							<div class="errorMsg">Oops. No results for "' + $parameters.urlname + '"</div>\
					</div>');
	    }
			else {
			group = data.results[0];
			$('.mug-badge', ctx).append(
				'<div class="mup-widget">\
					<div class="mup-bd">\
            <span class="">' + numberFormat(group.members) + ' members</span>\
            <span class="mup-stats"><div class="next-event"></div></span>\
            <span class="mup-button>'+ addLink('Join the group',group.link)+'</span>\
					</div>\
				</div>'
				);
      
	      $.getJSON($queries.events(), function(data) {
	        if (data.status && data.status.match(/^200/) == null) {
	          alert(data.status + ": " + data.details);
	        } else {
	            if (data.results.length == 0) {
		             $('.next-event', ctx).append('<span class="mup-tlabel">No upcoming event planned.<br>Join the Meetup group to get notifed.' + group.link + '</span>');
	            } else {
                    var event = data.results[0];
     console.log(event);
                    var venue = event.venue;
     console.log(venue);
                    var city;
                    if (!venue || !venue.city) {
                        city = group.city;
                    } else {
                        city = venue.city;
                    }
                    var state_country;
                    if (!venue || !venue.state) {
                        if (group.state == "") {
                            state_country = group.country.toUpperCase();
                        } else {
                            state_country = group.state;
                        }
                    } else {
                        state_country = venue.state;
                    }
                    var venue_addr;
                    if (venue) {
                        if (venue.name !== undefined) {
                            venue_addr = venue.name  + ", ";
                        } else if (venue.address_1 !== undefined) {
                            venue_addr = venue.address_1 + ", ";
                        } else {
                            venue_addr = "";
                        }
                    } else {
                       venue_addr = "";
                    }
                    var location = venue_addr + city;
                    $('.next-event', ctx).append('<div class="mup-tlabel">'+getFormattedDate(event.time) + ' &nbsp | &nbsp ' + getFormattedTime(event.time) + "</div>" + addLink(event.name, event.event_url)+'<div class="mup-tlabel">' + location + "</div>");
                }
            }
            });
	    }
	  });
	  
	});
</script>

</head>
<body>
	<div class="mug-badge"></div>

</body>
</html>